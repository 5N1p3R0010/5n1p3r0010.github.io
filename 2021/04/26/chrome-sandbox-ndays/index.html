<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="reference:&lt;a href=&quot;https://securitylab.github.com/research/chromium-ipc-vulnerabilities/&quot;&gt;https://securitylab.github.com/research/chromium-ipc-vulnerabilities/&lt;/a&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>chrome sandbox ndays | /home/5n1p3r0010</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Browser/" rel="tag">Browser</a></div><div class="post-time">2021-04-26</div></div></div><div class="container post-header"><h1>chrome sandbox ndays</h1></div><div class="container post-content"><p>reference:<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/chromium-ipc-vulnerabilities/">https://securitylab.github.com/research/chromium-ipc-vulnerabilities/</a></p>
<p>1.P0_1735:</p>
<p><a target="_blank" rel="noopener" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1735">https://bugs.chromium.org/p/project-zero/issues/detail?id=1735</a></p>
<p>PaymentRequest::Init初始化了一个spec智能指针</p>
<p>spec_ = std::make_unique&lt;PaymentRequestSpec&gt;(xx)</p>
<p>PaymentRequestDialogView::ShowInitialPaymentSheet()里创建PaymentSheetViewController类型的智能指针时调用其构造函数，将unique_ptr spec_转化成纯指针(raw pointer)。由于PaymentRequest::Init可以被多次调用，如果其在调用时spec_已经初始化，unique_ptr spec_会被释放掉；但是PaymentSheetViewController构造函数被调用时的raw pointer spec_并没有释放，在PaymentSheetViewController访问spec_会导致uaf。</p>
<p>即，例如如下代码，如果trigger()可以被多次调用，_b::_p会uaf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;iostream&quot;</span><br><span class="line">#include &quot;memory&quot;</span><br><span class="line"></span><br><span class="line">void put(std::string str)&#123;std::cout &lt;&lt; str &lt;&lt; std::endl;&#125;</span><br><span class="line"></span><br><span class="line">class a</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">	a()</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;a constructor&quot; &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	~a()&#123;std::cout &lt;&lt; &quot;a deconstructor&quot; &lt;&lt; std::endl;&#125;</span><br><span class="line">	</span><br><span class="line">	void (*func)(std::string str);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class b : public a</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">	b(a *_p):_p(_p)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;b constructor&quot; &lt;&lt; std::endl;</span><br><span class="line">	&#125;;</span><br><span class="line">	</span><br><span class="line">	~b()&#123;std::cout &lt;&lt; &quot;b decontructor&quot; &lt;&lt; std::endl;&#125;</span><br><span class="line">	</span><br><span class="line">	a *_p;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">std::unique_ptr&lt;class a&gt; _a;</span><br><span class="line">std::unique_ptr&lt;class b&gt; _b;</span><br><span class="line"></span><br><span class="line">void trigger()</span><br><span class="line">&#123;</span><br><span class="line">	_a &#x3D; std::make_unique&lt;a&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	trigger();</span><br><span class="line">	_b &#x3D; std::make_unique&lt;b&gt;(_a.get());</span><br><span class="line">	std::cout &lt;&lt; _a.get() &lt;&lt; std::endl &lt;&lt; _b-&gt;_p &lt;&lt; std::endl;</span><br><span class="line">	_b-&gt;_p-&gt;func &#x3D; put;</span><br><span class="line">	trigger();	&#x2F;&#x2F;[***]</span><br><span class="line">	_b-&gt;_p-&gt;func(&quot;uaf&quot;);</span><br><span class="line">	std::cout &lt;&lt; _a.get() &lt;&lt; std::endl &lt;&lt; _b-&gt;_p &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在[***]处，_b-&gt;_p会uaf</p>
<p><img src="image-20210426132216344.png" alt="image-20210426132216344"></p>
<p>或者直接使用asan编译可以看到uaf的asan信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">g++ xx.cc -g -fsanitize&#x3D;address -o xx</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;2451510&#x3D;&#x3D;ERROR: AddressSanitizer: heap-use-after-free on address 0x602000000010 at pc 0x555d4107396b bp 0x7fffac937230 sp 0x7fffac937220</span><br></pre></td></tr></table></figure>

<p>2.</p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>